class Drawer{constructor(canvas,optWidth,optHeight){canvas||((canvas=document.createElement("canvas")).setAttribute("width",optWidth),canvas.setAttribute("height",optHeight)),this.canvas=canvas,this.context=canvas.getContext("2d"),this.context.fillStyle="white",this.context.font="8px Calibri",this.context.msImageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.imageSmoothingEnabled=!1,this.bounds={width:optWidth||this.canvas.width,height:optHeight||this.canvas.height},this.objects=[],this.cameraPosition={x:0,y:0}}draw(objects,skipClear){return skipClear||this.clear(),objects||(objects=this.objects),(objects=objects.filter(object=>object).sort((a,b)=>(a.z||0)===(b.z||0)?(a.localZ||0)-(b.localZ||0):(a.z||0)-(b.z||0))).forEach(object=>{if(!object||object.hidden||object.absHidden)return;if(object.onDraw?.(object),object.invisible)return;if(object.x?.toString().indexOf("%")>=0){let width=object.spritesheet?object.spritesheet.cellSize:object.width||object.image.width;object.x=this.getRelativePositionX(Number(object.x.toString().slice(0,object.x.toString().length-1)))-width/2}if(object.y?.toString().indexOf("%")>=0){let height=object.spritesheet?object.spritesheet.cellSize:object.height||object.image.height;object.y=this.getRelativePositionY(Number(object.y.slice(0,object.y.length-1)))-height/2}let x=object.x+(object.static?0:this.cameraPosition.x),y=object.y+(object.static?0:this.cameraPosition.y);if(object.additionalX&&(x+=object.additionalX),object.additionalY&&(y+=object.additionalY),y=Math.round(y),x=Math.round(x),function(object,x,y,context){const{image:image,spritesheet:spritesheet,solidColor:solidColor,inverted:inverted,upperHalfOffsetY:upperHalfOffsetY,scale:scale,width:width,height:height,clipCircle:clipCircle,rotation:rotation,composite:composite,opacity:opacity,filter:filter,clip:clip}=object;if(!image?.naturalWidth&&!solidColor)return;context.save();const spriteCenterX=x+(spritesheet?spritesheet.cellSize/2:(width||image.width)/2),spriteCenterY=y+(spritesheet?spritesheet.cellSize/2:(height||image.height)/2);if(scale&&(context.translate(spriteCenterX,spriteCenterY),context.scale(scale,scale),context.translate(-spriteCenterX,-spriteCenterY)),rotation){const rotationRadians=rotation*(Math.PI/180);context.translate(spriteCenterX,spriteCenterY),context.rotate(rotationRadians),context.translate(-spriteCenterX,-spriteCenterY)}if(clipCircle){const radius=Math.min(width||image?.width,height||image?.height)/2;context.beginPath(),context.arc(spriteCenterX,spriteCenterY,radius,0,2*Math.PI,!1),context.clip()}if(clip&&4===clip.length){context.beginPath(),context.moveTo(clip[0][0],clip[0][1]);for(let i=1;i<clip.length;i++)context.lineTo(clip[i][0],clip[i][1]);context.closePath(),context.clip()}if(inverted&&(context.scale(-1,1),x=-x-(spritesheet?spritesheet.cellSize:width||image?.width)),composite&&(context.globalCompositeOperation=composite??"multiply"),filter&&(context.filter=filter),void 0!==opacity&&(context.globalAlpha=clamp(opacity,0,App.INF)),spritesheet){const cellNumber=spritesheet.cellNumber-1,cellSize=spritesheet.cellSize,columns=(spritesheet.rows,spritesheet.columns),sx=cellNumber%columns*cellSize,sy=Math.floor(cellNumber/columns)*cellSize,upperHalfHeight=Math.round(.8*cellSize),lowerHalfHeight=cellSize-upperHalfHeight,drawHalf=(half,offsetY)=>{let dy=y,sh=0===half?upperHalfHeight:lowerHalfHeight,dh=sh;0===half&&offsetY&&(dy+=offsetY),context.drawImage(image,sx,sy+(0===half?0:upperHalfHeight),cellSize,sh,x,dy+(0===half?0:upperHalfHeight),cellSize,dh)};drawHalf(0,upperHalfOffsetY),drawHalf(1)}else if(solidColor){const colorString=`rgb(${solidColor.r}, ${solidColor.g}, ${solidColor.b})`;context.fillStyle=colorString,context.fillRect(x,y,object.width||image.width,object.height||image.height)}else context.drawImage(image,x,y,object.width||image.width,object.height||image.height);context.restore()}(object,x,y,this.context),object.dirtyPatches){let hCell=object.spritesheet.cellSize/2;this.context.globalCompositeOperation="multiply";let areas=[[hCell-0,hCell,3],[hCell+3,hCell-3,2],[hCell-2,hCell+2,2]];areas=[],pRandom.save(),pRandom.seed=1;for(let i=0;i<6;i++)areas.push([hCell-pRandom.getIntBetween(-6,6),hCell-pRandom.getIntBetween(-6,6),pRandom.getIntBetween(1,6)]);pRandom.load(),areas.forEach(area=>{this.context.beginPath(),this.context.arc(x+area[0],y+object.upperHalfOffsetY+area[1],area[2],0,2*Math.PI,!1),this.context.fillStyle="rgba(124, 55, 29, 0.6)",this.context.fill(),this.context.lineWidth=0}),this.context.globalCompositeOperation="source-over"}object.text&&this.context.fillText(object.text,x,y),object.onLateDraw?.(object)}),this}pixelate(){let w=.4*this.bounds.width,h=.4*this.bounds.height;this.context.drawImage(this.canvas,0,0,w,h),this.context.drawImage(this.canvas,0,0,w,h,0,0,this.bounds.width,this.bounds.height)}drawImmediate(entity){if(entity.image){let img=new Image;img.src=entity.image,entity.image=img}this.draw([entity],!0)}clear(){this.context.clearRect(0,0,this.bounds.width,this.bounds.height)}getRelativePositionX(percent){return percent/100*this.bounds.width}getRelativePositionY(percent){return percent/100*this.bounds.height}addObject(object){let id=this.objects.push(object);return object.drawerId=id-1,object.drawerId}removeObject(object){if(!object||void 0===object.drawerId)return console.log("no drawer id, cant remove",object);this.objects[object.drawerId]=null,object.isRemoved=!0,this.objects.forEach(otherObject=>{otherObject?.parent?.drawerId===object.drawerId&&this.removeObject(otherObject)})}setCameraPosition(x,y,lerpSpeed){const targetX=x??this.cameraPosition.x,targetY=y??this.cameraPosition.y;lerpSpeed?this.setCameraPosition(lerp(this.cameraPosition.x,targetX,lerpSpeed),lerp(this.cameraPosition.y,targetY,lerpSpeed)):(this.cameraPosition.x=targetX,this.cameraPosition.y=targetY)}selectObjects(selector){return this.objects.filter(object=>object?.selector===selector)}}