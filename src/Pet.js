class Pet extends Object2d{defaultElevation=-20;y="100%";z=App.constants.NPC_PET_Z;additionalY=this.defaultElevation;animation={currentFrame:0,nextFrameTime:0,set:null};scriptedEventCooldowns={};state="idle";activeMoodlets=[];animObjectsQueue=[];accessoryObjects=[];castShadow=!0;speedOverride=0;additionalAccessories=[];constructor(petDefinition,additionalProps){super({image:petDefinition.spriteSkin?App.getPreloadedResource(petDefinition.spriteSkin):App.getPreloadedResource(petDefinition.sprite),spritesheet:petDefinition.spritesheet}),this.petDefinition=petDefinition,this.stats=this.petDefinition.stats,this.inventory=this.petDefinition.inventory,this.animations=this.petDefinition.animations,this.additionalY+=this.petDefinition.spritesheet.offsetY||0;for(let prop in additionalProps)this[prop]=additionalProps[prop];this.createOverlays(),this.equipAccessories(),this.handleGhost()}createOverlays(){this.needsToiletOverlay=new Object2d({parent:this,img:"resources/img/misc/needstoilet_01.png",x:0,y:0,width:this.petDefinition.spritesheet.cellSize,height:this.petDefinition.spritesheet.cellSize,hidden:!0,onDraw:overlay=>{overlay.mimicParent(["inverted","upperHalfOffsetY"]),Object2d.animations.flip(overlay,250)}}),this.dirtyOverlay=new Object2d({parent:this,img:"resources/img/misc/stinky_01.png",x:0,y:0,width:this.petDefinition.spritesheet.cellSize,height:this.petDefinition.spritesheet.cellSize,hidden:!0,onDraw:overlay=>{overlay.mimicParent(["inverted","upperHalfOffsetY"]),Object2d.animations.flip(overlay,300)}}),this.shadowOverlay=new Object2d({parent:this,img:"resources/img/misc/shadow_01.png",width:this.petDefinition.spritesheet.cellSize,height:this.petDefinition.spritesheet.cellSize,z:4.89,hidden:!this.castShadow,onDraw:overlay=>{if(overlay.hidden=!this.castShadow,overlay.x=this.x,App.currentScene.noShadows)return void(overlay.y=-9999);if(void 0===this.staticShadow&&void 0!==this.isMainPet&&(this.isMainPet?this.staticShadow=!1:this.staticShadow=!0),this.staticShadow)return void(overlay.y=this.y+this.additionalY+Math.ceil(this.spritesheet.cellSize/2.1));overlay.y=96+this.additionalY+(App.currentScene.shadowOffset||0)+(this.shadowOffset||0);const distanceToCaster=overlay.y-this.y;overlay.scale=1-.01*(distanceToCaster+4)}}),this.sicknessOverlay=new Object2d({parent:this,img:"resources/img/misc/sickness_overlay_01.png",x:0,y:0,hidden:!0,z:App.constants.ACTIVE_PET_Z+.1,onDraw:overlay=>{Object2d.animations.flip(overlay,750)}}),this.misbehavingOverlay=new Object2d({parent:this,img:"resources/img/misc/misbehaving_01.png",x:0,y:0,invisible:!0,z:App.constants.ACTIVE_PET_Z+.1,onDraw:overlay=>{overlay.invisible=!overlay.parent?.stats?.is_misbehaving,overlay.mimicParent(["inverted","upperHalfOffsetY"]),overlay.x-=overlay.parent.spritesheet.offsetY/2||0,Object2d.animations.pulseScale(overlay,.01,.05)}})}equipAccessories(){const ADULT_BASE_SIZE=this.petDefinition.spritesheetDefinitions[PetDefinition.LIFE_STAGE.adult]?.cellSize??32,OVERLAY_SCALE=this.petDefinition.spritesheet.cellSize/ADULT_BASE_SIZE||1,overlayOffset_x=(64-this.spritesheet.cellSize)/2,overlayOffset_y=(64-this.spritesheet.cellSize)/2;this.accessoryObjects.forEach(accessoryObject=>accessoryObject?.removeObject()),this.accessoryObjects=[];const accessoriesToEquip=[...this.petDefinition.accessories,...this.additionalAccessories];accessoriesToEquip&&accessoriesToEquip.forEach(accName=>{const accessory=App.definitions.accessories[accName];if(!accessory)return;const accessoryObject=accessory.createFn?accessory.createFn(this):new Object2d({parent:this,img:accessory.image,z:accessory.front?this.z+.1||5.1:this.z-.1||4.9,scale:1,spritesheet:{cellNumber:1,cellSize:64,rows:4,columns:4},onDraw:accessory.onDrawOverride??(overlay=>{overlay.mimicParent(),overlay.scale=overlay.scale*OVERLAY_SCALE,overlay.x-=overlayOffset_x,overlay.y-=overlayOffset_y,accessory.onDraw?.(overlay)})});this.accessoryObjects.push(accessoryObject)})}handleGhost(){if(this.animations._moving&&(this.animations.moving=this.animations._moving),!this.stats.is_ghost)return;const isDevilGhostType=this.stats.is_ghost===PetDefinition.GHOST_TYPE.devil;this.castShadow=!1,this.opacity=.7,this.additionalAccessories=isDevilGhostType?["monster wings","demon horns"]:["angel wings","angel halo"],this.showOutline(isDevilGhostType?"#B51919":"#F9E07B",!0),this.equipAccessories(),this.animations._moving=this.animations.moving,this.animations.moving=this.animations.idle_side;const initialAdditionalY=this.additionalY;let animationFloat=Math.random()*Math.PI;this.onDraw=me=>{const floatSpeed=me.isMoving?.0075:.005;animationFloat+=floatSpeed*App.deltaTime,animationFloat>App.PI2&&(animationFloat=0),me._ghostAnimationFloat=animationFloat,me.additionalY=["eating","sitting"].includes(App.pet.state)?initialAdditionalY:initialAdditionalY-3-3*Math.sin(animationFloat)}}onLateDraw(){this.behavior()}behavior(){return this.isMainPet=this===App.pet,this.stats.is_dead?this.handleDead():this.stats.is_egg?this.handleEgg():(this.think(),this.moveToTarget(this.speedOverride||this.stats.speed),this.stateManager(),this.handleAnimation(),void Object2d.animations.pixelBreath(this))}handleWants(){if(!this.isMainPet||App.haveAnyDisplays())return;const{current_want:current_want}=this.stats;current_want.pendingFulfilled&&(this.showThought(App.constants.WANT_TYPES.fulfilled),current_want.pendingFulfilled=null),App.fullTime>current_want.next_refresh_ms&&(App.petDefinition.refreshWant(),App.pet.showCurrentWant())}handleDead(){const me=this;this.x=-600,App.toggleGameplayControls(!1,()=>{const handleReceiveEgg=()=>{const lastPet=App.petDefinition;App.pet.removeObject(),App.petDefinition=new PetDefinition({name:getRandomName(),sprite:randomFromArray(PET_BABY_CHARACTERS)}).setStats({is_egg:!0}),App.petDefinition.inventory=lastPet.inventory,App.petDefinition.stats.gold=lastPet.stats.gold,App.petDefinition.deceasedPredecessors=[...lastPet.deceasedPredecessors,{birthday:lastPet.birthday,family:lastPet.family,sprite:lastPet.sprite,name:lastPet.name}],App.pet=App.createActivePet(App.petDefinition),setTimeout(()=>{Activities.playEggUfoAnimation(()=>App.handlers.show_set_pet_name_dialog())},100),App.setScene(App.scene.home),App.toggleGameplayControls(!0)};if(App.pet.stats.is_revived_once)App.displayConfirm("Do you want to receive a new egg?",[{name:"yes",onclick:handleReceiveEgg},{name:"no",class:"back-btn",onclick:()=>{}}],!1);else{const revivalPrice=clamp(Math.floor(App.pet.stats.gold/2),App.constants.MIN_REVIVE_GOLDS,App.constants.MAX_REVIVE_GOLDS);App.displayConfirm(`<b>${App.petDefinition.name}</b> is dead but you can choose to revive them only <b>once</b>, do you want to revive them?`,[{name:`revive ($${revivalPrice})`,onclick:()=>!App.pay(revivalPrice)||(Activities.revive(),!1)},{name:"get a new egg",onclick:handleReceiveEgg},{name:"back",class:"back-btn",onclick:()=>{}}])}}),this.ghostObject||(this.ghostObject=new Object2d({img:"resources/img/misc/ghost_01.png",x:0,y:-5,onDraw:ghostObject=>{Object2d.animations.bob(ghostObject,.001,.1),Object2d.animations.flip(ghostObject,1500),App.pet.stats.is_dead||(ghostObject.removeObject(),delete me.ghostObject)}}),App.setScene(App.scene.graveyard))}handleEgg(){this.x=-600,App.toggleGameplayControls(!1,()=>{App.displayPopup("Wait for your egg to hatch")});const getEggSpritesheet=()=>this.stats.is_ghost===PetDefinition.GHOST_TYPE.angel?"resources/img/misc/egg_angel_01.png":this.stats.is_ghost===PetDefinition.GHOST_TYPE.devil?"resources/img/misc/egg_devil_01.png":"resources/img/misc/egg_normal_01.png";if(!this.eggObject)return this.eggStartTime=Date.now(),this.hatchTime=this.eggStartTime+random(15e3,3e4),this.eggObject=new Object2d({img:getEggSpritesheet(),spritesheet:{cellSize:16,rows:1,columns:2,cellNumber:1},x:"50%",y:"80%"}),this.eggMotionFloat=0,void(this.eggMotionFloatSpeed=.001);this.eggMotionFloatSpeed=clamp(this.eggMotionFloatSpeed+1e-6*App.deltaTime,0,.02),this.eggMotionFloat+=this.eggMotionFloatSpeed*App.deltaTime;const motion=Math.sin(this.eggMotionFloat);.02===this.eggMotionFloatSpeed&&(this.eggObject.spritesheet.cellNumber=2),this.eggObject.x=40+1.5*motion,Date.now()>this.hatchTime&&(this.stats.is_egg=!1,App.setScene(App.scene.home),App.toggleGameplayControls(!0),this.eggObject?.removeObject(),this.eggObject=null,this.triggerScriptedState("uncomfortable",5e3))}_switchScene(scene){switch(this.y="100%",this.x="50%",scene){case"house":App.background.setImg("resources/img/background/house/01.jpg");break;case"kitchen":App.background.setImg("resources/img/background/house/kitchen_01.png"),App.foods.x=40,App.foods.y=58,this.x=62,this.y=74;break;case"park":App.background.setImg("resources/img/background/outside/park_01.png")}}sleep(){this.stats.is_sleeping||App.currentScene!==App.scene.home||(this.stopMove(),this.x="50%",this.stats.is_misbehaving||this.hasMoodlet("rested")&&!App.isSleepHour()?this.playRefuseAnimation():this.stats.is_sleeping=!0)}feed(foodSpriteCellNumber,value,type,forced,onEndFn){const me=this;type||(type="food"),App.toggleGameplayControls(!1,()=>{this.stopScriptedState()}),this.stopMove();const shouldRefuse=()=>{if("food"===type)if(this.hasMoodlet("full"))return!0;if(this.stats.is_misbehaving&&this.stats.current_hunger>this.stats.max_hunger/2&&random(0,100)>=10)return!0;const reFedAmount=this.petDefinition.stats.last_eaten.reduce((sum,current)=>current===foodSpriteCellNumber?sum+1:sum,0),isMilk=foodSpriteCellNumber===App.definitions.food.milk.sprite;return reFedAmount>=App.constants.FEEDING_PICKINESS.refeedingTolerance&&"med"!==type&&!isMilk&&(this.showThought("thought_vomit"),!0)},wantedFoodItem=App.definitions.food[this.stats.current_want.item];if(this.petDefinition.checkWant(foodSpriteCellNumber===wantedFoodItem?.sprite,App.constants.WANT_TYPES.food)&&(forced=!0),!forced&&shouldRefuse())return me.playRefuseAnimation(),App.setScene(App.scene.home),App.uiFood.style.visibility="hidden",App.toggleGameplayControls(!0),!1;this.petDefinition.stats.last_eaten=[foodSpriteCellNumber,...this.petDefinition.stats.last_eaten].slice(0,App.constants.FEEDING_PICKINESS.bufferSize),Missions.done(Missions.TYPES.food);let baseFoodSpriteIndex=foodSpriteCellNumber-1,foodSpriteIndex=baseFoodSpriteIndex,lastFoodSpriteIndexChangeMs=App.time;return App.uiFood.style.visibility="visible",App.uiFood.setAttribute("index",foodSpriteCellNumber-1),this.inverted=!1,this.stats.current_hunger+=value||0,App.setScene(App.scene.kitchen),this.triggerScriptedState("eating",4e3,null,!0,()=>{if("med"===type)this.playCheeringAnimationIfTrue(this.hasMoodlet("healthy"),()=>{App.setScene(App.scene.home),App.toggleGameplayControls(!0)});else{const end=noLongerHungry=>{App.closeAllDisplays(),App.toggleGameplayControls(!0),App.setScene(App.scene.home),onEndFn?.(noLongerHungry)};this.hasMoodlet("full")?(App.toggleGameplayControls(!1),this.playCheeringAnimation(()=>{end(!0)})):end()}App.uiFood.style.visibility="hidden"},()=>{App.time-lastFoodSpriteIndexChangeMs>1200&&(lastFoodSpriteIndexChangeMs=App.time,foodSpriteIndex=clamp(foodSpriteIndex+1,baseFoodSpriteIndex,baseFoodSpriteIndex+2),App.uiFood.setAttribute("index",foodSpriteIndex))}),!0}playCheeringAnimationIfTrue(requirement,onEndFn){requirement?this.playCheeringAnimation(onEndFn):onEndFn&&onEndFn()}playCheeringAnimation(onEndFn,noSoundAndIcon,ms=2e3){this.stopMove(),noSoundAndIcon||setTimeout(()=>this.playSound("resources/sounds/cheer_success.ogg",!0));const stateName=noSoundAndIcon?"cheering":"cheering_with_icon";this.triggerScriptedState(stateName,ms,null,!0,()=>{onEndFn&&onEndFn()})}playRefuseAnimation(onEndFn){this.stopMove(),this.triggerScriptedState("refuse",2e3,null,!0,()=>{onEndFn&&onEndFn()})}playAngryAnimation(onEndFn){this.stopMove(),this.triggerScriptedState("angry",2e3,null,!0,()=>{onEndFn&&onEndFn()})}playUncomfortableAnimation(onEndFn){this.stopMove(),this.triggerScriptedState("uncomfortable",2e3,null,!0,()=>{onEndFn&&onEndFn()})}attemptMisbehave(forced){if(!(App.fullTime-this.stats.last_time_misbehave_attempted>6*App.constants.ONE_HOUR)&&!forced)return;this.stats.last_time_misbehave_attempted=App.fullTime;let startingChance=1;switch(this.petDefinition.lifeStage){case PetDefinition.LIFE_STAGE.teen:startingChance=18;break;case PetDefinition.LIFE_STAGE.child:startingChance=9;break;case PetDefinition.LIFE_STAGE.baby:startingChance=5}const helperDisciplineAdd=(100-this.stats.current_discipline)/2.8;random(startingChance,this.stats.max_discipline)>this.stats.current_discipline+helperDisciplineAdd&&(this.stats.is_misbehaving=!0)}praise(){if(this.stopMove(),App.reloadScene(),this.stats.is_misbehaving){const me=this;this.triggerScriptedState("shocked",random(-200,500),null,!0,()=>me.playCheeringAnimation(!1,!0)),this.stats.current_want.type||(this.petDefinition.refreshWant(),this.showCurrentWant()),this.stats.current_discipline-=random(2,4)}else{const shouldIncreaseDiscipline=App.fullTime-this.stats.last_time_praise_given>7*App.constants.ONE_MINUTE;shouldIncreaseDiscipline&&(this.stats.last_time_praise_given=App.fullTime,Activities.task_nonSwayingFloatingObjects(10,["resources/img/misc/arrow_up_green_01.png"],[100,150]),this.stats.current_discipline+=random(5,15),App.save()),this.playCheeringAnimation(!1,!shouldIncreaseDiscipline)}}scold(){if(this.stopMove(),App.reloadScene(),this.stats.is_misbehaving){random(0,4)>0?(this.stats.current_discipline+=random(5,10),this.stats.is_misbehaving=!1,this.triggerScriptedState("mild_uncomfortable",2e3,null,!0),Activities.task_nonSwayingFloatingObjects(10,["resources/img/misc/arrow_up_green_01.png"],[100,150]),setTimeout(()=>this.playSound("resources/sounds/cheer_success.ogg",!0))):this.playRefuseAnimation()}else this.playUncomfortableAnimation(),random(0,3)?setTimeout(()=>this.activeBubble?.removeObject?.()):(this.petDefinition.adjustCare(!1),setTimeout(()=>this.showThought("thought_heart_broken"))),this.stats.current_fun-=random(4,10),this.stats.current_discipline-=random(0,2)}think(){if(this.nextThinkTime)return this.nextThinkTime<App.lastTime?void(this.nextThinkTime=0):void 0;this.nextThinkTime=App.lastTime+500,this.statsManager(),"sleeping"!=this.state&&(this.isDuringScriptedState()||(this.wander(),this.handleRandomGestures(),this.handleWants(),this.handleRandomSentences()))}handleRandomSentences(){if(!this.isMainPet)return;if(this.stats.current_expression<20)return;const me=this,now=App.time||0,setNextTime=time=>{me.nextRandomSentenceTime=time??now+App.constants.ONE_MINUTE*random(1,5)};this.nextRandomSentenceTime||setNextTime(App.constants.ONE_SECOND*random(30,180)),this.nextRandomSentenceTime<now&&(setNextTime(),this.nextRandomSentenceQueued||(this.nextRandomSentenceQueued=!0,App.queueEvent(()=>{me.say(generateRandomSentence()),me.nextRandomSentenceQueued=!1})))}handleRandomGestures(){if(random(0,100)<10){if(this.hasMoodlet("sleepy"))return this.triggerScriptedState("angry",4e3,random(2e4,3e4)),void this.stopMove();if(this.hasMoodlet("hungry")||this.hasMoodlet("bored"))return this.triggerScriptedState("uncomfortable",4e3,random(2e4,3e4)),void this.stopMove();if(this.stats.is_misbehaving){switch(random(0,1)){case 0:this.triggerScriptedState("uncomfortable",4e3,random(2e4,3e4));break;case 1:this.triggerScriptedState("angry",4e3,random(2e4,3e4))}return void this.stopMove()}}if(!["bored","sleepy","hungry","sick"].map(moodName=>this.hasMoodlet(moodName)).some(moodlet=>moodlet))if(random(0,100)<10){let animations=[{name:"sitting",length:random(2e3,4e3)},{name:"blush",length:random(550,1e3)},{name:"cheering",length:random(550,1e3)},{name:"shocked",length:random(450,800)}],animation=randomFromArray(animations);this.triggerScriptedState(animation.name,animation.length,random(1e4,2e4)),this.stopMove()}else random(0,105)<3&&this.isMainPet&&this.jump()}statsManager(isOfflineProgression,hour=App.hour){if(!this.isMainPet||this.stats.is_dead)return;let stats=this.stats;const previousStats=Object.assign({},this.stats);let depletion_mult=1,offlineAndIsNight=!1;switch(isOfflineProgression?(depletion_mult=.25,App.isSleepHour(hour)&&(offlineAndIsNight=!0,depletion_mult=.05)):this.attemptMisbehave(),this.petDefinition.lifeStage){case PetDefinition.LIFE_STAGE.baby:depletion_mult*=1.65;break;case PetDefinition.LIFE_STAGE.child:depletion_mult*=1.46;break;case PetDefinition.LIFE_STAGE.teen:depletion_mult*=1.3}this.stats.is_at_parents&&(hour<App.constants.PARENT_DAYCARE_START||hour>=App.constants.PARENT_DAYCARE_END)&&(isOfflineProgression||Activities.stayAtParents(!0),this.stats.is_at_parents=!1),!offlineAndIsNight&&this.stats.is_at_parents&&(depletion_mult=-.1),this.stats.is_at_vacation&&(depletion_mult=-.1);let hunger_depletion_rate=stats.hunger_depletion_rate*depletion_mult,sleep_depletion_rate=stats.sleep_depletion_rate*depletion_mult,fun_depletion_rate=stats.fun_depletion_rate*depletion_mult,bladder_depletion_rate=stats.bladder_depletion_rate*depletion_mult,health_depletion_rate=stats.health_depletion_rate*depletion_mult,cleanliness_depletion_rate=stats.cleanliness_depletion_rate*depletion_mult,discipline_depletion_rate=this.stats.is_at_vacation?0:stats.discipline_depletion_rate,max_death_tick=stats.max_death_tick;switch(this.petDefinition.lifeStage){case PetDefinition.LIFE_STAGE.baby:max_death_tick=stats.baby_max_death_tick;break;case PetDefinition.LIFE_STAGE.child:max_death_tick=stats.child_max_death_tick;break;case PetDefinition.LIFE_STAGE.teen:max_death_tick=stats.teen_max_death_tick}if(isOfflineProgression&&(sleep_depletion_rate/=2),this.stats.is_sleeping||offlineAndIsNight){let sleepAdditionalDepletionMult=1;offlineAndIsNight&&(sleepAdditionalDepletionMult=2),sleep_depletion_rate=-stats.sleep_replenish_rate*sleepAdditionalDepletionMult}stats.current_hunger=clamp(stats.current_hunger,0,stats.max_hunger),stats.current_sleep=clamp(stats.current_sleep,0,stats.max_sleep),stats.current_fun=clamp(stats.current_fun,0,stats.max_fun),stats.current_bladder=clamp(stats.current_bladder,0,stats.max_bladder),stats.current_health=clamp(stats.current_health,0,stats.max_health),stats.current_cleanliness=clamp(stats.current_cleanliness,0,stats.max_cleanliness),stats.current_discipline=clamp(stats.current_discipline,0,stats.max_discipline),stats.current_hunger-=hunger_depletion_rate,stats.current_hunger<=0&&(stats.current_hunger=0),stats.current_sleep-=sleep_depletion_rate,stats.current_sleep<=0&&(stats.current_sleep=0,App.currentScene===App.scene.home&&(this.stats.is_sleeping=!0)),stats.current_fun-=fun_depletion_rate,stats.current_fun<=0&&(stats.current_fun=0),stats.current_bladder-=bladder_depletion_rate,stats.current_bladder<=0&&(stats.current_bladder=stats.max_bladder,stats.is_potty_trained?isOfflineProgression||App.queueEvent(()=>{Activities.poop(!0)},"poop"):this.stats.has_poop_out?this.stats.has_poop_out+=1:this.stats.has_poop_out=1);const spawnedPoopObjects=App.drawer.selectObjects("poop"),poopObjectsToBeSpawned=this.stats.has_poop_out-spawnedPoopObjects.length;if(poopObjectsToBeSpawned>0&&spawnedPoopObjects.length<App.constants.POOP_POSITIONS.length&&!this.isDuringScriptedState())for(let i=0;i<poopObjectsToBeSpawned;i++){const position=App.constants.POOP_POSITIONS.at(i+spawnedPoopObjects.length);if(!position)break;new Object2d({image:App.preloadedResources["resources/img/misc/poop.png"],...position,selector:"poop",onDraw:me=>{Object2d.animations.flip(me,300)}})}this.needsToiletOverlay.hidden=stats.current_bladder>stats.max_bladder/4,stats.current_cleanliness-=cleanliness_depletion_rate,stats.current_cleanliness<=0&&(stats.current_cleanliness=0),stats.current_cleanliness<=25?this.dirtyOverlay.hidden=!1:this.dirtyOverlay.hidden=!0,!this.stats.has_poop_out&&this.dirtyOverlay.hidden||(stats.current_health-=health_depletion_rate*stats.health_depletion_mult,stats.current_cleanliness-=cleanliness_depletion_rate*stats.cleanliness_depletion_mult),stats.current_health<=0&&(stats.current_health=0),stats.current_discipline-=discipline_depletion_rate,stats.current_discipline<=0&&(stats.current_discipline=0,stats.is_misbehaving=!0),stats.current_health<=0&&stats.current_cleanliness<=0&&stats.current_fun<=0&&stats.current_hunger<=0&&!stats.is_ghost?stats.current_death_tick-=stats.death_tick_rate:stats.current_death_tick=max_death_tick,stats.current_death_tick<=0&&(App.pet.stats.is_dead=!0),this.sicknessOverlay.hidden=stats.current_death_tick>=max_death_tick/2;const careAffectingStats=["current_health","current_fun","current_hunger","current_cleanliness"];careAffectingStats.forEach(statName=>{0!=previousStats[statName]&&0==this.stats[statName]&&(this.petDefinition.adjustCare(!1),stats.current_discipline-=random(2,10))});const careIncreaseThreshold=this.stats.hunger_satisfaction||85,eligibleForCareIncrease=careAffectingStats.every(statName=>this.stats[statName]>careIncreaseThreshold),shouldResetCareIncreaseFlag=careAffectingStats.some(statName=>this.stats[statName]<65);eligibleForCareIncrease?this.stats.should_care_increase&&(this.stats.should_care_increase=!1,this.petDefinition.adjustCare(!0)):shouldResetCareIncreaseFlag&&(this.stats.should_care_increase=!0),this.triggerMoodlet(stats.current_hunger,stats.hunger_min_desire,"hungry",stats.hunger_satisfaction,"full"),this.triggerMoodlet(stats.current_sleep,stats.sleep_min_desire,"sleepy",stats.sleep_satisfaction,"rested"),this.triggerMoodlet(stats.current_fun,stats.fun_min_desire,"bored",stats.fun_satisfaction,"amused"),this.triggerMoodlet(stats.current_health,.25*stats.max_health,"sick",.8*stats.max_health,"healthy")}triggerMoodlet(current,min,minName,max,maxName){current<min?this.addMoodlet(minName):this.removeMoodlet(minName),current>max?this.addMoodlet(maxName):this.removeMoodlet(maxName)}addMoodlet(mood){if(!(this.activeMoodlets.indexOf(mood)>=0))return this.activeMoodlets.push(mood),!0}removeMoodlet(mood){let index=this.activeMoodlets.indexOf(mood);if(-1!=index)return this.activeMoodlets.splice(index,1),!0}hasMoodlet(mood){return this.activeMoodlets.indexOf(mood)>=0}triggerScriptedState(state,length,cooldown,forced,onEndFn,driverFn){return new Promise((resolve,reject)=>{if(!forced){if(this.scriptedEventTime)return resolve();if(this.scriptedEventCooldowns[state]&&this.scriptedEventCooldowns[state]>App.lastTime)return resolve()}cooldown&&(this.scriptedEventCooldowns[state]=App.lastTime+cooldown),this.scriptedEventTime=App.lastTime+length,this.scriptedEventOnEndFn=(...args)=>{"function"==typeof onEndFn&&onEndFn(...args),onEndFn=null,resolve()},this.scriptedEventDriverFn=driverFn,this.setState(state)})}setState(newState){if(newState!=this.state){this.animation.currentFrame=0,this.animation.nextFrameTime=0,this.animation.set=this.animations[newState];const{set:set}=this.animation;0===set?.sound?.interval&&(set.sound._played=!1),this.state=newState}}stopScriptedState(){return this.stopMove(),this.scriptedEventTime=null,!!this.scriptedEventOnEndFn&&(this.scriptedEventOnEndFn(),!0)}isDuringScriptedState(){return!!this.scriptedEventTime}stateManager(){if(this.scriptedEventTime){if(!(this.scriptedEventTime<App.lastTime))return void(this.scriptedEventDriverFn&&this.scriptedEventDriverFn(this));if(this.stopScriptedState())return}if(this.stats.is_sleeping){if((this.stats.current_sleep>=this.stats.max_sleep||this.hasMoodlet("rested")&&Math.random()<.01*this.stats.light_sleepiness)&&!App.isSleepHour())return this.stats.is_sleeping=!1,void App.toggleGameplayControls(!0);this.stopMove(),this.setState("sleeping"),App.toggleGameplayControls(!1,()=>{this.stats.is_sleeping=!1,App.toggleGameplayControls(!0),this.hasMoodlet("rested")?App.pet.playCheeringAnimation():App.pet.triggerScriptedState("uncomfortable",3e3)})}else this.isMoving?this.setState("moving"):-1==this.state.indexOf("idle")&&(this.hasMoodlet("hungry")||this.hasMoodlet("sleepy")||this.hasMoodlet("bored")||this.hasMoodlet("sick")?random(0,1)?this.setState("idle_uncomfortable"):this.setState("idle_side_uncomfortable"):this.setState("idle"))}handleAnimation(){const me=this;if(!this.animation.set)return;const{set:set}=this.animation,frameRound=set.end-set.start;if(this.animation.nextFrameTime<App.lastTime){if(this.animObjectsQueue.length&&this.animObjectsQueue.forEach(obj=>{obj._lives&&obj._lives>0?obj._lives--:App.drawer.removeObject(obj)}),this.animation.nextFrameTime=App.lastTime+set.frameTime,this.animation.currentFrame=(this.animation.currentFrame+1)%frameRound,this.spritesheet.cellNumber=set.start+this.animation.currentFrame,set.sound){const filePath=`resources/sounds/${set.sound.file}`;0===set.sound.interval?set.sound._played||(set.sound._played=!0,this.playSound(filePath)):(set.sound._counter=(set.sound._counter||0)+1,set.sound._counter===set.sound.interval&&(set.sound._counter=0,this.playSound(filePath)))}set.objects&&set.objects.forEach(objectDef=>{if(objectDef._counter||(objectDef._counter=0),++objectDef._counter==objectDef.interval){objectDef._counter=0;let object=new Object2d(objectDef);me.animObjectsQueue.push(object)}})}}wander(){this.isMoving&&(this.nextRandomTargetSelect=0),this.nextRandomTargetSelect||(this.nextRandomTargetSelect=App.lastTime+1e3*random(this.stats.wander_min,this.stats.wander_max)),App.lastTime>this.nextRandomTargetSelect&&(this.targetX=random(this.drawer.getRelativePositionX(0),this.drawer.getRelativePositionX(100)-this.spritesheet.cellSize),this.nextRandomTargetSelect=0)}jump(strength=.28,silent,onEndFn,gravity=.001){if(this.isJumping)return!1;this.isJumping=!0;const startY=this.y;let velocity=strength;silent||this.playSound("resources/sounds/jump.ogg",!0),this.triggerScriptedState("jumping",App.INF,0,!0,()=>{this.y=startY,this.isJumping=!1},()=>{velocity-=gravity*App.deltaTime,this.y-=velocity*App.deltaTime,this.y>=startY&&(this.stopScriptedState(),onEndFn?.())})}simulateAwayProgression(elapsedTime){this.isMainPet=!0;let iterations=Math.floor(elapsedTime/1e3);for(let i=0;i<iterations;i++)this.stats.is_egg?this.handleEgg():this.statsManager()}simulateOfflineProgression(elapsedTime){this.isMainPet=!0;const{MAX_OFFLINE_PROGRESSION_SECS:MAX_OFFLINE_PROGRESSION_SECS}=App.constants,startTime=Date.now();let iterations=Math.floor(2*clamp(elapsedTime/1e3,0,MAX_OFFLINE_PROGRESSION_SECS));for(let i=0;i<iterations;i++){elapsedTime-=500;let hour=new Date(startTime-elapsedTime).getHours();this.stats.is_egg?this.handleEgg():this.statsManager(!0,hour)}}ageUp(){this.petDefinition.ageUp(),this.removeObject(),App.pet=App.createActivePet(this.petDefinition)}serializeStats(){return this.petDefinition.serializeStats()}loadStats(json){this.petDefinition.loadStats(json)}playSound(sound,force){this.isMainPet&&!App.haveAnyDisplays()&&App.playSound(sound,force)}getStatsDepletionRates(isOffline,targetLifeStage,hour){App.petDefinition.maxStats();const currentLifeStage=this.petDefinition.lifeStage;null!=targetLifeStage&&(this.petDefinition.lifeStage=targetLifeStage);const{MAX_OFFLINE_PROGRESSION_SECS:MAX_OFFLINE_PROGRESSION_SECS}=App.constants,report={};for(let i=0;i<MAX_OFFLINE_PROGRESSION_SECS;i++){this.statsManager(isOffline,hour),this.statsManager(isOffline,hour);let min={m:i/60,s:i,h:i/60/60};this.stats.current_hunger<=0&&!report.hunger&&(report.hunger={...min,stat:this.stats.current_hunger}),this.stats.current_sleep<=2&&!report.sleep&&(report.sleep={...min,stat:this.stats.current_sleep}),this.stats.current_fun<=0&&!report.fun&&(report.fun={...min,stat:this.stats.current_fun}),this.stats.current_bladder<=3&&!report.bladder&&(report.bladder={...min,stat:this.stats.current_bladder}),this.stats.current_cleanliness<=0&&!report.cleanliness&&(report.cleanliness={...min,stat:this.stats.current_cleanliness}),this.stats.current_health<=0&&!report.health&&(report.health={...min,stat:this.stats.current_health}),this.stats.current_death_tick<=0&&!report.death_tick&&(report.death_tick={...min,stat:this.stats.current_death_tick}),this.stats.current_discipline<=0&&!report.discipline&&(report.discipline={...min,stat:this.stats.current_discipline})}console.log("Time every stats hit ~0:",report),this.petDefinition.lifeStage=currentLifeStage,App.petDefinition.maxStats()}showCurrentWant(withName){if(this.stats.current_want.type&&(this.showThought(this.stats.current_want.type,this.stats.current_want.item),withName)){const display=App.displayMessageBubble(this.petDefinition.getWantName());setTimeout(()=>display.close(),3500)}}showThought(type,item,disappearDelay=5e3){const bubble=new Object2d({parent:this,img:"resources/img/misc/thought_bubble_01.png",x:-999,y:-999,opacity:0,z:App.constants.ACTIVE_PET_Z+.1,shouldFadeout:!1,float:0,onDraw:me=>{me.x=this.x,me.float+=.004*App.deltaTime,me.float>App.PI2&&(me.float=0),me.y=this.y-1.5*this.spritesheet.cellSize-(1.8*this.spritesheet.offsetY||0)+Math.sin(me.float);const opacityTarget=me.shouldFadeout?0:1;me.opacity=lerp(me.opacity,opacityTarget,.01*App.deltaTime)}});if(this.activeBubble?.removeObject?.(),this.activeBubble=bubble,[App.constants.WANT_TYPES.food,App.constants.WANT_TYPES.playdate,App.constants.WANT_TYPES.item].includes(type)){new Object2d({parent:bubble,img:`resources/img/misc/thought_bubble_type_${type}.png`,x:0,y:0,opacity:0,z:10.01,shouldFadeout:!1,float:0,onDraw:me=>{me.opacity=bubble.opacity,me.x=bubble.x,me.y=bubble.y}})}switch(type){case App.constants.WANT_TYPES.food:const foodSpriteIndex=App.definitions.food[item]?.sprite;if(!foodSpriteIndex)break;new Object2d({parent:bubble,image:App.preloadedResources[App.constants.FOOD_SPRITESHEET],x:10,y:10,z:10,scale:.62,spritesheet:{cellNumber:foodSpriteIndex,cellSize:24,rows:33,columns:33},onDraw:me=>{me.opacity=bubble.opacity,me.x=bubble.x+4,me.y=bubble.y+1}});break;case App.constants.WANT_TYPES.playdate:const friendDef=item instanceof PetDefinition?item:this.petDefinition.friends[item];if(!friendDef)break;new Object2d({parent:bubble,image:App.preloadedResources[friendDef.sprite],x:10,y:10,z:10,scale:.62,spritesheet:friendDef.spritesheet,onDraw:me=>{me.opacity=bubble.opacity,me.x=bubble.x+(friendDef.spritesheet.offsetY??0),me.y=bubble.y-4+(friendDef.spritesheet.offsetY??0)}});break;case App.constants.WANT_TYPES.item:const itemSpriteIndex=App.definitions.item[item]?.sprite;if(!itemSpriteIndex)break;new Object2d({parent:bubble,image:App.preloadedResources["resources/img/item/items.png"],x:10,y:10,z:10,scale:.7,spritesheet:{cellNumber:itemSpriteIndex,cellSize:22,rows:10,columns:10},onDraw:me=>{me.opacity=bubble.opacity,me.x=bubble.x+5,me.y=bubble.y+2}});break;case App.constants.WANT_TYPES.minigame:new Object2d({parent:bubble,image:App.preloadedResources["resources/img/misc/minigames.png"],x:10,y:10,z:10,onDraw:me=>{me.opacity=bubble.opacity,me.x=bubble.x,me.y=bubble.y}});break;case App.constants.WANT_TYPES.fulfilled:new Object2d({parent:bubble,image:App.preloadedResources["resources/img/misc/want_fulfilled.png"],x:10,y:10,z:10,onDraw:me=>{me.opacity=bubble.opacity,me.x=bubble.x,me.y=bubble.y}});break;default:new Object2d({parent:bubble,image:App.preloadedResources[`resources/img/misc/${type}.png`],x:10,y:10,z:10,onDraw:me=>{me.opacity=bubble.opacity,me.x=bubble.x,me.y=bubble.y}})}setTimeout(()=>{bubble.shouldFadeout=!0,setTimeout(()=>bubble.removeObject(),1e3)},disappearDelay)}setLocalZBasedOnSelf(otherObject){const currentBoundingBox=this.getBoundingBox(),otherBoundingBox=otherObject.getBoundingBox(),localZ=otherBoundingBox.y+otherBoundingBox.height-(currentBoundingBox.y+currentBoundingBox.height);otherObject.z=this.z,otherObject.localZ=localZ}say(sentence,ms=6e3){const message=App.displayMessageBubble(sentence,this.petDefinition.getFullCSprite());setTimeout(()=>message?.close(),ms)}static scriptedEventDrivers={playing:function(start){this.pet.setState("moving"),void 0===this.playing_current_target_x&&(this.playing_current_target_x=!0,this.pet.targetX=0),this.pet.x==this.pet.targetX&&(0==this.pet.targetX?this.pet.targetX=100-this.pet.spritesheet.cellSize:this.pet.targetX=0)},moveCheck:function(){this.pet.x!==this.pet.targetX&&void 0!==this.pet.targetX||this.pet.stopScriptedState()},movingOut:function(start){this.pet.setState("moving"),void 0===this.moving_init_done&&(this.moving_init_done=!0,this.pet.x=0,this.pet.targetX=-20)},movingIn:function(){this.pet.setState("moving"),void 0===this.moving_init_done&&(this.moving_init_done=!0,this.pet.x="105%",this.pet.targetX=-20)},playingWithItem:function(){if(!["grimoire","skate","fidget spinner"].includes(this.item?.name)){if(this.lastMs&&App.time<=this.lastMs+500)return;this.lastMs=App.time}switch(this.item?.name){case"skate":this.init||(this.init=!0,App.setScene(App.scene.skate_park),this.animationPosition={x:-30,y:75},this.pet.setState("idle_side"),this.pet.inverted=!0,this.animationSpeed=.075,this.petOffset={x:0,y:0}),this.animationPosition.x+=this.animationSpeed*App.deltaTime;const isRightPast=this.animationPosition.x>App.drawer.bounds.width+32,isLeftPast=this.animationPosition.x<-64;(isRightPast||isLeftPast)&&(this.animationSpeed=isRightPast?-.075:.075,this.pet.inverted=this.animationSpeed>0,random(0,2)&&0===this.itemObject.rotation?(this.petOffset.y,this.itemObject.rotation=15,this.pet.setState("jumping"),this.animationPosition.y=55):(this.pet.setState("idle_side"),this.itemObject.rotation=0,this.petOffset.x=0,this.petOffset.y=0,this.animationPosition.y=75)),this.pet.x=this.animationPosition.x+this.petOffset.x+(this.pet.petDefinition.spritesheet.offsetY||0),this.pet.y=this.animationPosition.y+this.petOffset.y+(this.pet.petDefinition.spritesheet.offsetY||0),this.itemObject.x=this.animationPosition.x+5,this.itemObject.y=this.animationPosition.y;break;case"grimoire":this.startTime||(this.startTime=App.time,this.float=0,this.x=0,this.itemObject.scale=1,this.itemObject.opacity=1),App.time<=this.startTime+2e3?(this.pet.setState("idle"),this.pet.x="50%",this.pet.y="80%",this.itemObject.x="50%"):(this.pet.setState(this.itemObject.opacity>0?"shocked":"mild_uncomfortable"),this.float+=.025*App.deltaTime,this.x=this.pet.x,this.itemObject.x=this.x-20*Math.cos(this.float),this.itemObject.scale+=.001*this.float,this.float>80&&(this.itemObject.opacity-=.001*App.deltaTime)),this.itemObject.y=70-20*Math.sin(this.float),this.itemObject.z=App.constants.ACTIVE_PET_Z+.1;break;case"microphone":this.pet.x=randomFromArray(["25%","50%","75%"]),this.pet.y="85%",this.pet.inverted=!this.pet.inverted,this.itemObject.x=this.pet.x,this.itemObject.y=App.drawer.getRelativePositionY(92)-App.constants.ITEM_SPRITESHEET_DIMENSIONS.cellSize,this.itemObject.z=this.pet.z+.1,this.itemObject.inverted=this.pet.inverted,this.itemObject.onDraw=function(){this._animFloat||(this._animFloat=0),this._animFloat+=.005*App.deltaTime,this.rotation=0+25*Math.sin(this._animFloat)};break;case"rubicube":case"smartphone":case"magazine":case"retroboy":const extendedAnimationItems=["smartphone","retroboy"];this.pet.setState(randomFromArray(["sitting","sitting",extendedAnimationItems.includes(this.item?.name)?"eating":"sitting","shocked","blush"])),this.itemObject.x=this.pet.x+App.petDefinition.spritesheet.cellSize/1.5,this.itemObject.y=this.pet.y-13+random(-2,2),"rubicube"===this.item?.name&&(this.itemObject.inverted=!this.itemObject.inverted);break;case"ball":this.pet.y="100%",this.pet.x="50%",this.itemObject.x=randomFromArray(["40%","60%"]),this.itemObject.y=App.drawer.getRelativePositionY(95)-App.constants.ITEM_SPRITESHEET_DIMENSIONS.cellSize+random(-2,2),this.itemObject.z=this.pet.z+randomFromArray([.1,-.1]);break;case"music player":this.pet.x=randomFromArray(["25%","50%","75%"]),this.pet.y=randomFromArray(["100%","80%","90%"]),this.pet.inverted=!this.pet.inverted,this.itemObject.x="50%",this.itemObject.y="70%",this.itemObject.onDraw=function(){this._animFloat||(this._animFloat=0),this._animFloat+=.015*App.deltaTime,this.scale=1+.09*Math.sin(this._animFloat)};break;case"dumble":this.pet.setState(randomFromArray(["uncomfortable","shocked"])),this.pet.x="50%",this.pet.y="90%",this.itemObject.z=this.pet.z+.1,this.itemObject.x="50%",this.itemObject.y=App.drawer.getRelativePositionY(95)-App.constants.ITEM_SPRITESHEET_DIMENSIONS.cellSize+random(-2,2),this.itemObject.inverted=!this.itemObject.inverted;break;case"foxy":case"bear":this.pet.setState(randomFromArray(["cheering","shocked","blush"]));const xOffset=this.pet.petDefinition.spritesheet.cellSize/2*(random(0,1)?-.5:1);this.itemObject.z=this.pet.z+.1,this.itemObject.x=this.pet.x+xOffset,this.itemObject.y=this.pet.y-10+random(-2,2),this.itemObject.inverted=!this.itemObject.inverted;break;case"fidget spinner":if(this.itemObject._speed||(this.itemObject._speed=-10),this.itemObject._speed=lerp(this.itemObject._speed,-5,5e-4*App.deltaTime),this.itemObject._speed<0&&this.pet.setState("mild_uncomfortable"),this.itemObject._speed<=-2){this.pet.setState(randomFromArray(["cheering","shocked","blush"])),setTimeout(()=>this.pet.setState("idle"),500),this.itemObject._speed=random(5,50);const xOffset=this.pet.petDefinition.spritesheet.cellSize/2.5*randomFromArray([-.5,.25,1]);this.itemObject.x=this.pet.x+xOffset}const cappedSpeed=clamp(this.itemObject._speed,0,999);this.itemObject.z=this.pet.z+.1,this.itemObject.y=this.pet.y-6,this.itemObject.rotation+=cappedSpeed*App.deltaTime;break;case"rattle":this.pet.y="100%",this.pet.x=randomFromArray(["30%","50%","70%"]);const possibleItemPositions=["25%","50%","75%"];this.itemObject.x=randomFromArray(possibleItemPositions),this.itemObject.y=randomFromArray(possibleItemPositions),this.itemObject.inverted=!this.itemObject.inverted;break;case"robotty":switch(void 0===this.stateIndex?(this.pet.y="80%",this.pet.x="50%",this.pet.setState("idle"),this.itemObject.z=this.pet.z+.1,this.stateIndex=-1,this.positions=["20%","30%","40%","50%","60%","70%","80%"]):App.playSound("resources/sounds/ui_click_04.ogg",!0),this.stateIndex%3==0&&(this.pet.inverted=Boolean(random(0,1)),this.pet.setState(randomFromArray(["cheering","shocked","idle_side","jumping","jumping","idle"])),setTimeout(()=>this.pet.setState("idle"),350)),this.stateIndex++,this.stateIndex>=this.positions.length&&(this.positions.reverse(),this.stateIndex=0),this.itemObject.x=this.positions.at(this.stateIndex),this.stateIndex%4){case 0:this.itemObject.rotation=-5;break;case 1:case 3:this.itemObject.rotation=0;break;case 2:this.itemObject.rotation=5}switch(this.stateIndex%2){case 0:this.itemObject.y="85%";break;case 1:this.itemObject.y="80%"}break;default:if(Math.random()<.5){const possibleStates=["cheering","eating","shocked","sitting","blush"];this.pet.setState(randomFromArray(possibleStates)),this.pet.inverted=!!random(0,1)}}}}}